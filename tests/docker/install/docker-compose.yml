# compose the regression tests
#
# environment variables:
# * SOLARWINDS_APM_VERSION: the agent version being tested, it must already be built
#   under the project dist/ directory
#
# use the `run` command to get an interactive container for debugging:
# (debian) $ docker-compose run --rm <service name> /bin/bash
# (alpine) $ docker-compose run --rm <service name> /bin/sh
# (centos) $ docker-compose run --rm --user root <service name> /bin/bash

version: '2.4'

x-command-install-test: &command-install-test
  command: sh _helper_run_install_tests.sh

x-envvars-install-test: &envvars-install-test
  SOLARWINDS_APM_VERSION: ${SOLARWINDS_APM_VERSION:-}
  MODE: ${MODE}
  SW_APM_COLLECTOR_AO_PROD: ${SW_APM_COLLECTOR_AO_PROD}
  SW_APM_COLLECTOR_PROD: ${SW_APM_COLLECTOR_PROD}
  SW_APM_COLLECTOR_STAGING: ${SW_APM_COLLECTOR_STAGING}
  SW_APM_SERVICE_KEY_AO_PROD: ${SW_APM_SERVICE_KEY_AO_PROD}
  SW_APM_SERVICE_KEY_PROD: ${SW_APM_SERVICE_KEY_PROD}
  SW_APM_SERVICE_KEY_STAGING: ${SW_APM_SERVICE_KEY_STAGING}

x-volumes-codebase: &volumes-codebase
  volumes:
    - ../../../:/code/python-solarwinds
    - ./_helper_run_install_tests.sh:/workspace/_helper_run_install_tests.sh
    - ./install_tests.sh:/workspace/install_tests.sh
    - ./client.py:/workspace/client.py
    - ./app.py:/workspace/app.py
    - ./ao_issuer_ca_public_cert.crt:/workspace/ao_issuer_ca_public_cert.crt

x-workdir: &workdir
  working_dir: /workspace

services:
  #--------------------------------------------------------------------
  # install test matrix
  # each service is a combination of python version and distro to test.
  #--------------------------------------------------------------------

  #--------------------------------------------------------------------
  # Python 3.6
  #--------------------------------------------------------------------

  py3.6-install-debian8:
    hostname: "py3.6-debian8"
    image: "python:3.6-jessie"
    << : *command-install-test
    << : *workdir
    << : *volumes-codebase
    environment:
      << : *envvars-install-test

  py3.6-install-debian9:
    hostname: "py3.6-debian9"
    image: "python:3.6-stretch"
    << : *command-install-test
    << : *workdir
    << : *volumes-codebase
    environment:
      << : *envvars-install-test

  py3.6-install-debian10:
    hostname: "py3.6-debian10"
    image: "python:3.6-buster"
    << : *command-install-test
    << : *workdir
    << : *volumes-codebase
    environment:
      << : *envvars-install-test

  py3.6-install-ubuntu14.04:
    hostname: "py3.6-ubuntu14.04"
    image: "ubuntu:14.04"
    << : *command-install-test
    << : *workdir
    << : *volumes-codebase
    environment:
      << : *envvars-install-test

  py3.6-install-ubuntu16.04:
    hostname: "py3.6-ubuntu16.04"
    image: "ubuntu:16.04"
    << : *command-install-test
    << : *workdir
    << : *volumes-codebase
    environment:
      << : *envvars-install-test

  py3.6-install-ubuntu18.04:
    hostname: "py3.6-ubuntu18.04"
    image: "ubuntu:18.04"
    << : *command-install-test
    << : *workdir
    << : *volumes-codebase
    environment:
      << : *envvars-install-test

  py3.6-install-ubuntu20.04:
    hostname: "py3.6-ubuntu20.04"
    image: "ubuntu:20.04"
    << : *command-install-test
    << : *workdir
    << : *volumes-codebase
    environment:
      << : *envvars-install-test

  py3.6-install-centos7:
    hostname: "py3.6-centos7"
    image: "centos/python-36-centos7"
    user: root
    << : *command-install-test
    << : *workdir
    << : *volumes-codebase
    environment:
      << : *envvars-install-test

  py3.6-install-centos8:
    hostname: "py3.6-centos8"
    image: "centos:8"
    << : *command-install-test
    << : *workdir
    << : *volumes-codebase
    environment:
      << : *envvars-install-test

  py3.6-install-amazon2016.09:
    hostname: "py3.6-amazon2016.09"
    image: "amazonlinux:2016.09"
    << : *command-install-test
    << : *workdir
    << : *volumes-codebase
    environment:
      << : *envvars-install-test

  py3.6-install-amazon2017.03:
    hostname: "py3.6-amazon2017.03"
    image: "amazonlinux:2017.03"
    << : *command-install-test
    << : *workdir
    << : *volumes-codebase
    environment:
      << : *envvars-install-test

  py3.6-install-amazon2017.09:
    hostname: "py3.6-amazon2017.09"
    image: "amazonlinux:2017.09"
    << : *command-install-test
    << : *workdir
    << : *volumes-codebase
    environment:
      << : *envvars-install-test

  py3.6-install-amazon2018.03:
    hostname: "py3.6-amazon2018.03"
    image: "amazonlinux:2018.03"
    << : *command-install-test
    << : *workdir
    << : *volumes-codebase
    environment:
      << : *envvars-install-test

  py3.6-install-amazon2:
    hostname: "py3.6-amazon2"
    image: "amazonlinux:2"
    << : *command-install-test
    << : *workdir
    << : *volumes-codebase
    environment:
      << : *envvars-install-test

  py3.6-install-alpine3.12:
    hostname: "py3.6-alpine3.12"
    image: "python:3.6-alpine3.12"
    << : *command-install-test
    << : *workdir
    << : *volumes-codebase
    environment:
      << : *envvars-install-test

  py3.6-install-alpine3.13:
    hostname: "py3.6-alpine3.13"
    image: "python:3.6-alpine3.13"
    << : *command-install-test
    << : *workdir
    << : *volumes-codebase
    environment:
      << : *envvars-install-test

  py3.6-install-alpine3.14:
    hostname: "py3.6-alpine3.14"
    image: "python:3.6-alpine3.14"
    << : *command-install-test
    << : *workdir
    << : *volumes-codebase
    environment:
      << : *envvars-install-test

  py3.6-install-alpine3.15:
    hostname: "py3.6-alpine3.15"
    image: "python:3.6-alpine3.15"
    << : *command-install-test
    << : *workdir
    << : *volumes-codebase
    environment:
      << : *envvars-install-test

  py3.6-install-alpine3.16:
    hostname: "py3.6-alpine3.16"
    image: "alpine:3.16"
    << : *command-install-test
    << : *workdir
    << : *volumes-codebase
    environment:
      << : *envvars-install-test

  #--------------------------------------------------------------------
  # Python 3.7
  #--------------------------------------------------------------------

  py3.7-install-debian10:
    hostname: "py3.7-debian10"
    image: "python:3.7-buster"
    << : *command-install-test
    << : *workdir
    << : *volumes-codebase
    environment:
      << : *envvars-install-test

  #--------------------------------------------------------------------
  # Python 3.8
  #--------------------------------------------------------------------

  py3.8-install-alpine3.13:
    hostname: "py3.8-alpine3.13"
    image: "python:3.8-alpine3.13"
    << : *command-install-test
    << : *workdir
    << : *volumes-codebase
    environment:
      << : *envvars-install-test

  py3.8-install-alpine3.14:
    hostname: "py3.8-alpine3.14"
    image: "python:3.8-alpine3.14"
    << : *command-install-test
    << : *workdir
    << : *volumes-codebase
    environment:
      << : *envvars-install-test

  py3.8-install-centos7:
    hostname: "py3.8-centos7"
    image: "centos/python-38-centos7"
    user: root
    << : *command-install-test
    << : *workdir
    << : *volumes-codebase
    environment:
      << : *envvars-install-test

  py3.8-install-centos8:
    hostname: "py3.8-centos8"
    image: "centos:8"
    << : *command-install-test
    << : *workdir
    << : *volumes-codebase
    environment:
      << : *envvars-install-test

  py3.8-install-debian10:
    hostname: "py3.8-debian10"
    image: "python:3.8-buster"
    << : *command-install-test
    << : *workdir
    << : *volumes-codebase
    environment:
      << : *envvars-install-test

  #--------------------------------------------------------------------
  # Python 3.9
  #--------------------------------------------------------------------

  py3.9-install-centos8:
    hostname: "py3.9-centos8"
    image: "centos:8"
    << : *command-install-test
    << : *workdir
    << : *volumes-codebase
    environment:
      << : *envvars-install-test

  py3.9-install-debian10:
    hostname: "py3.9-debian10"
    image: "python:3.9-buster"
    << : *command-install-test
    << : *workdir
    << : *volumes-codebase
    environment:
      << : *envvars-install-test

  #--------------------------------------------------------------------
  # Python 3.10
  #--------------------------------------------------------------------

  py3.10-install-debian10:
    hostname: "py3.10-debian10"
    image: "python:3.10-buster"
    << : *command-install-test
    << : *workdir
    << : *volumes-codebase
    environment:
      << : *envvars-install-test

  #--------------------------------------------------------------------
  # Python 3.11
  #--------------------------------------------------------------------